#!/usr/bin/env python3
import json
import os
import sys
import urllib.request
from datetime import datetime
import uuid

# Add Lambda runtime path for boto3
sys.path.insert(0, '/var/runtime')
sys.path.insert(0, '/opt/python')

try:
    import boto3
    BOTO3_AVAILABLE = True
except ImportError:
    BOTO3_AVAILABLE = False

LAMBDA_EXTENSION_NAME = os.path.basename(__file__)
RUNTIME_API = os.environ.get('AWS_LAMBDA_RUNTIME_API', '')
DYNAMODB_TABLE = os.environ.get('DYNAMODB_TABLE', 'lambda-state-events')
AWS_REGION = os.environ.get('AWS_REGION', 'us-east-1')

def log(message):
    print(f"[{LAMBDA_EXTENSION_NAME}] {message}", flush=True)

def register_extension():
    url = f'http://{RUNTIME_API}/2020-01-01/extension/register'
    headers = {'Lambda-Extension-Name': LAMBDA_EXTENSION_NAME}
    data = json.dumps({'events': ['INVOKE', 'SHUTDOWN']}).encode('utf-8')
    
    req = urllib.request.Request(url, data=data, headers=headers, method='POST')
    response = urllib.request.urlopen(req)
    extension_id = response.headers['Lambda-Extension-Identifier']
    
    log(f"Registered with ID: {extension_id}")
    return extension_id

def next_event(extension_id):
    url = f'http://{RUNTIME_API}/2020-01-01/extension/event/next'
    headers = {'Lambda-Extension-Identifier': extension_id}
    
    req = urllib.request.Request(url, headers=headers, method='GET')
    response = urllib.request.urlopen(req)
    return json.loads(response.read())

def write_to_dynamodb(event_type, event_data):
    """Write event to DynamoDB"""
    if not BOTO3_AVAILABLE:
        log("boto3 not available, skipping DynamoDB write")
        return
    
    try:
        dynamodb = boto3.resource('dynamodb', region_name=AWS_REGION)
        table = dynamodb.Table(DYNAMODB_TABLE)
        
        item = {
            'eventId': str(uuid.uuid4()),
            'timestamp': datetime.utcnow().isoformat(),
            'eventType': event_type,
            'functionName': os.environ.get('AWS_LAMBDA_FUNCTION_NAME', 'unknown'),
            'functionVersion': os.environ.get('AWS_LAMBDA_FUNCTION_VERSION', 'unknown'),
            'requestId': event_data.get('requestId', 'N/A'),
            'shutdownReason': event_data.get('shutdownReason', 'N/A'),
            'ttl': int(datetime.utcnow().timestamp()) + 86400
        }
        
        table.put_item(Item=item)
        log(f"✅ Wrote {event_type} to DynamoDB: {item['eventId']}")
        
    except Exception as e:
        log(f"❌ DynamoDB write failed: {e}")

def main():
    try:
        log(f"Starting (boto3: {'available' if BOTO3_AVAILABLE else 'not available'})")
        
        if not RUNTIME_API:
            log("ERROR: AWS_LAMBDA_RUNTIME_API not set")
            sys.exit(1)
        
        extension_id = register_extension()
        
        while True:
            event = next_event(extension_id)
            event_type = event.get('eventType')
            
            log(f"Event: {event_type}")
            
            if event_type == 'SHUTDOWN':
                log(f"SHUTDOWN detected! Reason: {event.get('shutdownReason', 'unknown')}")
                write_to_dynamodb('SHUTDOWN', event)
                log("Extension exiting")
                sys.exit(0)
            elif event_type == 'INVOKE':
                # Don't write INVOKE events here - the function handler does that
                log("INVOKE event (handler will log)")
                
    except Exception as e:
        log(f"Error: {e}")
        import traceback
        log(traceback.format_exc())
        sys.exit(1)

if __name__ == '__main__':
    main()
